{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>متجري - لوحة المنتجات</title>
  <link rel="stylesheet" href="{% static 'css/Ntro/atro.css' %}">
  <style>
    :root{
      --bg:#f7fafc;
      --card:#ffffff;
      --accent:#1da1f2;
      --muted:#6b7280;
      --glass: rgba(30,144,255,0.04);
      --radius:16px;
      font-family: 'Cairo', 'Segoe UI', Arial, sans-serif;
    }
    html,body{height:100%;}
    body{
      margin:0;
      background:linear-gradient(135deg,#e3f0ff 0%, #f7fafc 100%);
      color:#222;
      -webkit-font-smoothing:antialiased;
      padding:24px;
    }
    .container{
      max-width:1200px;
      margin:0 auto;
    }
    header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo{
      width:56px;height:56px;border-radius:16px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:32px;box-shadow:0 2px 8px rgba(30,144,255,0.12)
    }
    h1{font-size:22px;margin:0;color:var(--accent);}
    .controls{display:flex;gap:10px;align-items:center}
    .search-section {
        margin-bottom: 24px;
        background: var(--card);
        padding: 16px;
        border-radius: var(--radius);
        box-shadow: 0 2px 8px rgba(30,144,255,0.06);
    }
    .search-inputs {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }
    .category-select,
    .sort-select {
        padding: 8px 16px;
        border: 1px solid #e1e8f0;
        border-radius: 12px;
        background: #fff;
        color: #444;
        min-width: 140px;
    }
    .search-btn {
        padding: 8px 24px;
    }
    @media (max-width: 768px) {
        .search-inputs {
            flex-direction: column;
        }
        .search-btn {
            width: 100%;
        }
    }
    .btn{
      background:var(--accent);color:#fff;border:none;padding:10px 18px;border-radius:16px;font-weight:600;cursor:pointer;transition:transform .12s ease;box-shadow:0 6px 18px rgba(30,144,255,0.08)
    }
    .btn.ghost{background:transparent;border:1px solid var(--accent);color:var(--accent)}
    .btn:active{transform:translateY(1px)}
    .btn.pay{background:linear-gradient(90deg,#1da1f2 0%,#0f9d58 100%);color:#fff;}
    .main{
      display:grid;grid-template-columns:1fr 340px;gap:24px;align-items:start;
    }
    .product-grid{
      display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:20px;
    }
    .card{
      background:var(--card);padding:18px;border-radius:16px;box-shadow:0 6px 18px rgba(30,144,255,0.06);
      display:flex;flex-direction:column;gap:12px;min-height:220px;
      border:1px solid #e3eafc;
      transition:box-shadow .2s;
    }
    .card:hover{box-shadow:0 12px 32px rgba(30,144,255,0.12);}
    .thumb{height:140px;border-radius:12px;overflow:hidden;background:#e3eafc;display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .meta{display:flex;justify-content:space-between;align-items:center}
    .meta h3{margin:0;font-size:17px;color:#222;}
    .price{font-weight:700;color:var(--accent)}
    .actions{display:flex;gap:8px}
    .small{padding:8px 12px;border-radius:12px;font-weight:600}
    aside{background:var(--card);padding:18px;border-radius:16px;box-shadow:0 2px 8px rgba(30,144,255,0.06)}
    .sidebar-section{margin-bottom:18px}
    .cart-item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;background:var(--glass)}
    .cart-item img{width:48px;height:48px;border-radius:10px;object-fit:cover}
    .telegram-contact{
      background:var(--glass);padding:18px;border-radius:16px;margin-top:24px;text-align:center;
      box-shadow:0 2px 8px rgba(30,144,255,0.06);
    }
    .telegram-contact h3{margin:0 0 8px 0;color:var(--accent);}
    .telegram-contact a{
      display:inline-block;
      background:#1da1f2;
      color:#fff;
      padding:8px 18px;
      border-radius:12px;
      font-weight:600;
      text-decoration:none;
      margin-top:8px;
      transition:background .2s;
    }
    .telegram-contact a:hover{background:#0f9d58;}
    @media (max-width:900px){
      .main{grid-template-columns:1fr}
      .controls .search input{width:120px}
      aside{margin-top:24px;}
    }

    .modal-card {
      background: linear-gradient(180deg,#fff,#f8fafc);
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    .styled-form .form-row {
      margin-bottom: 20px;
    }
    .styled-form label {
      display: block;
      margin-bottom: 8px;
      color: #444;
      font-weight: 500;
    }
    .styled-form input[type="text"],
    .styled-form input[type="number"],
    .styled-form textarea {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #e1e8f0;
      border-radius: 12px;
      font-size: 15px;
      transition: all 0.3s;
    }
    .styled-form input:focus,
    .styled-form textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(29,161,242,0.1);
    }
    .telegram-input {
      display: flex;
      align-items: center;
      background: #fff;
      border: 1px solid #e1e8f0;
      border-radius: 12px;
      overflow: hidden;
    }
    .telegram-input .prefix {
      padding: 12px 16px;
      background: #f8fafc;
      color: #64748b;
      border-left: 1px solid #e1e8f0;
    }
    .telegram-input input {
      border: none !important;
      border-radius: 0 !important;
    }
    .image-upload {
      position: relative;
    }
    .preview-area {
      width: 100%;
      height: 200px;
      border: 2px dashed #e1e8f0;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 8px;
      overflow: hidden;
    }
    .upload-placeholder {
      color: #64748b;
    }
    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    .messages-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      width: 300px;
    }
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 14px;
      color: #fff;
    }
    .alert-success {
      background-color: #28a745;
    }
    .alert-error {
      background-color: #dc3545;
    }
    .alert-info {
      background-color: #17a2b8;
    }
    .alert-warning {
      background-color: #ffc107;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">م</div>
        <div>
          <h1>متجري</h1>
          <div style="font-size:13px;color:var(--muted);">مرحباً، {{ request.user.username }}</div>
        </div>
      </div>
      <div class="controls">
        <div class="search-section">
    <form method="GET" class="search-form">
        <div class="search-inputs">
            <div class="search">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
                <input type="text" name="q" value="{{ q }}" placeholder="ابحث عن سلعة...">
            </div>
            <select name="category" class="category-select">
                <option value="">جميع الفئات</option>
                {% for val, txt in categories %}
                    <option value="{{ val }}" {% if val == current_category %}selected{% endif %}>{{ txt }}</option>
                {% endfor %}
            </select>
            <select name="sort" class="sort-select">
                <option value="-created_at" {% if current_sort == '-created_at' %}selected{% endif %}>الأحدث</option>
                <option value="price" {% if current_sort == 'price' %}selected{% endif %}>السعر: الأقل أولاً</option>
                <option value="-price" {% if current_sort == '-price' %}selected{% endif %}>السعر: الأعلى أولاً</option>
                <option value="name" {% if current_sort == 'name' %}selected{% endif %}>أبجدياً</option>
            </select>
            <button type="submit" class="btn search-btn">بحث</button>
        </div>
    </form>
</div>
        <button class="btn" id="addBtn">إضافة سلعة</button>
        <a href="{% url 'purchases' %}" class="btn ghost">مشتريات</a>
        <a href="{% url 'cart' %}" class="btn ghost">السلة</a>
        <a href="{% url 'logout' %}" class="btn ghost">خروج</a>
      </div>
    </header>
    <div class="main">
      <section>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h2 style="margin:0;color:var(--accent);">المنتجات</h2>
          <div style="color:var(--muted);font-size:14px">{{ products.count }} منتج</div>
        </div>
        <div class="product-grid" id="productsGrid">
          {% for product in products %}
          <article class="card" data-name="{{ product.name|lower }}">
            <div class="thumb">
              {% if product.img %}
                <img src="{{ product.img.url }}" alt="{{ product.name }}">
              {% else %}
                <div style="text-align:center;color:var(--muted);padding:10px">لا توجد صورة</div>
              {% endif %}
            </div>
            <div class="meta">
              <h3>{{ product.name }}</h3>
              <div class="price">{{ product.price }} د.ع</div>
            </div>
            <div style="color:var(--muted);font-size:14px">{{ product.description|truncatechars:80 }}</div>
          
<div class="actions" style="margin-top:auto">
    <form method="POST" action="{% url 'buy' product.id %}">
        {% csrf_token %}
        <button type="submit" class="small btn">شراء الآن</button>
    </form>
    <form method="POST" action="{% url 'add_to_cart' product.id %}">
        {% csrf_token %}
        <button type="submit" class="small btn ghost">أضف للسلة</button>
    </form>
</div>
          </article>
          {% empty %}
          <div style="color:var(--muted);padding:20px;background:var(--glass);border-radius:12px">لا توجد منتجات حتى الآن.</div>
          {% endfor %}
        </div>
        {% comment %} <div class="telegram-contact">
          <h3>تواصل معنا عبر تيليجرام</h3>
          <div>لأي استفسار أو طلب خاص، يرجى التواصل معنا مباشرة:</div>
          <a href="https://t.me/JokerPython3" target="_blank">@JokerPtrhon3</a>
        </div> {% endcomment %}
      </section>
      <aside>
        <div class="sidebar-section">
          <h3 style="margin:0 0 8px 0;color:var(--accent);">نظرة عامة على السلة</h3>
          {% if cart.items.exists %}
            {% for item in cart.items.all %}
            <div class="cart-item">
              {% if item.product.img %}
                <img src="{{ item.product.img.url }}" alt="{{ item.product.name }}">
              {% else %}
                <div style="width:48px;height:48px;background:var(--glass);border-radius:10px"></div>
              {% endif %}
              <div style="flex:1">
                <div style="font-size:14px">{{ item.product.name }}</div>
                <div style="font-size:13px;color:var(--muted)">{{ item.quantity }} × {{ item.product.price }} د.ع</div>
              </div>
            </div>
            {% endfor %}
            <div style="margin-top:10px;display:flex;gap:8px;justify-content:space-between;align-items:center">
              <div style="font-weight:700;color:var(--accent);">الإجمالي: {{ cart.total }} د.ع</div>
              {% comment %} <a href="{% url 'checkout' %}" class="btn pay">إتمام الدفع الذكي</a> {% endcomment %}
            </div>
          {% else %}
            <div style="color:var(--muted)">السلة فارغة</div>
          {% endif %}
        </div>
        <div class="sidebar-section">
          <h3 style="margin:0 0 8px 0;color:var(--accent);">روابط سريعة</h3>
          <div style="display:flex;flex-direction:column;gap:8px">
            <a href="{% url 'products' %}" class="btn ghost">عرض المنتجات</a>
            <a href="{% url 'orders' %}" class="btn ghost">الطلبات</a>
            <a href="{% url 'profile' %}" class="btn ghost">الملف الشخصي</a>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="modal-card">
      <h3 style="margin-top:0;color:var(--accent);">إضافة منتج جديد</h3>
      <form id="addForm" method="POST" enctype="multipart/form-data" action="{% url 'add_product' %}" class="styled-form">
        {% csrf_token %}
        <div class="form-row">
          <label>اسم المنتج</label>
          <input type="text" name="name" required>
        </div>
        <div class="form-row">
          <label>الوصف</label>
          <textarea name="description" required></textarea>
        </div>
        <div class="form-row">
          <label>السعر</label>
          <input type="number" name="price" step="0.01" min="0" required>
        </div>
        <div class="form-row">
          <label>الفئة</label>
          <select name="category" required>
            {% for val, txt in categories %}
                <option value="{{ val }}">{{ txt }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-row">
          <label>الصورة</label>
          <input type="file" name="image" accept="image/*">
        </div>
        <div class="form-actions">
          <button type="submit" class="btn pay">إضافة</button>
        </div>
      </form>
    </div>
  </div>

  <div class="messages-container">
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
    {% endif %}
ment.getElementById('imageInput');
  <script>imagePreview');
    const modal = document.getElementById('modal');
    const addBtn = document.getElementById('addBtn');unction() {
    const closeModal = document.getElementById('closeModal');
    addBtn.addEventListener('click', ()=> modal.classList.add('open'));
    closeModal.addEventListener('click', ()=> modal.classList.remove('open'));onst reader = new FileReader();
    modal.addEventListener('click', (e)=>{ if(e.target === modal) modal.classList.remove('open') }); reader.onload = function(e) {
          imagePreview.src = e.target.result;

    const searchInput = document.getElementById('searchInput');
    const productsGrid = document.getElementById('productsGrid');
    searchInput.addEventListener('input', ()=>{
      const q = searchInput.value.trim().toLowerCase();      }
      const cards = productsGrid.querySelectorAll('.card');
      cards.forEach(c=>{
        const name = c.getAttribute('data-name') || '';
        c.style.display = name.includes(q) ? 'flex' : 'none';
      })
    });


    document.querySelectorAll('.btn.pay').forEach(function(btn){
      btn.addEventListener('click', function(e){
        if(btn.tagName === 'A') return;
        e.preventDefault();
        btn.textContent = "جاري معالجة الدفع ...";
        setTimeout(function(){
          btn.textContent = "تم الدفع بنجاح!";
          btn.style.background = "#0f9d58";
          setTimeout(function(){ location.reload(); }, 1200);
        }, 1500);
      });
    document.querySelectorAll('.btn.pay').forEach(function(btn){
      btn.addEventListener('click', function(e){
        if(btn.tagName === 'A') return;
        e.preventDefault();
        btn.textContent = "جاري معالجة الدفع ...";
        setTimeout(function(){
          btn.textContent = "تم الدفع بنجاح!";
          btn.style.background = "#0f9d58";
          setTimeout(function(){ location.reload(); }, 1200);
        }, 1500);
      });
    });


    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    const uploadPlaceholder = document.querySelector('.upload-placeholder');

    imageInput.addEventListener('change', function() {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          imagePreview.src = e.target.result;
          imagePreview.style.display = 'block';
          uploadPlaceholder.style.display = 'none';
        }
        reader.readAsDataURL(file);
      }
    });
  </script>
</body>
</html>
</body>
</html>
